.container#reservations
  .row
    .col-lg-12
      %h1
        %i.bi.bi-house-fill
        Reservations
        - if params[:route_id]
          \-
          = Route.find(params[:route_id]).name

  .row
    .col-lg-2
      - unless action_name == 'search'
        %section.menu
          %h3 Status
          = link_to "Pending pickup", admin_reservations_path, class: 'link'
          = surround("(",")") do 
            = @count_pending_pickups
          %br
          = link_to "Un-Routed", admin_reservations_path(unrouted: true), class: 'link'
          = surround("(",")") do 
            = @count_not_routed
          %br
          = link_to "Manually Geocoded", admin_reservations_path(geocoded: false), class: 'link'
          = surround("(",")") do 
            = @count_not_geocoded
          %br
          = link_to "Not Polygon Routed", admin_reservations_path(not_polygon_routed: true), class: 'link'
          = surround("(",")") do 
            = @count_not_polygon_routed
          %br
          = link_to "Picked up", admin_reservations_path(picked_up: true), class: 'link'
          = surround("(",")") do 
            = @count_picked_up
          %br
          = link_to "Missing", admin_reservations_path(missing: true), class: 'link'
          = surround("(",")") do 
            = @count_missing
          %br
          = link_to "Cancelled", admin_reservations_path(cancelled: true), class: 'link'
          = surround("(",")") do 
            = @count_cancelled
          %br
          = link_to "Archived", admin_reservations_path(archived: true), class: 'link'
          = surround("(",")") do 
            = @count_archived
          %br
          = link_to "Unconfirmed", admin_reservations_path(unconfirmed: true), class: 'link'
          = surround("(",")") do 
            = @count_unconfirmed
          %br
          = link_to "All", admin_reservations_path(all: true), class: 'link'

        %section.menu
          %h3 Routes
          - Route.all.each do |route|
            = link_to route.name, admin_reservations_path(route_id: route.id), class: 'link'
            = surround("(",")") do 
              = Reservation.where.not(status: ['archived', 'cancelled']).where(route: route).count
            %br

        %section.menu
          %h3 Zones
          - Zone.all.each do |zone|
            = link_to zone.name, admin_zone_path(zone)
            = surround("(", ")") do 
              = Reservation.not_archived.joins(:route).where("routes.zone_id = ?",zone.id).count
            %br

    .col-lg-10
      .row
        .col-lg-8
          = render 'search'
        .col-lg-4
          - if current_user.editor? || current_user.administrator?
            .admin-nav
              %nav
                %ul.nav.justify-content-end
                  %li.nav-item
                    = link_to new_reservation_path, class: 'nav-link' do
                      %i.bi.bi-plus-lg
                      Reservation
                  %li.nav-item
                    = button_to admin_process_all_routes_path, class: 'btn btn-warning btn-sm', data: {  turbo_confirm: 'Are you sure? This will re-route ALL reservations that have auto-routing enabled.'} do
                      %i.bi.bi-lightning-fill
                      Process routes


      .pagination= pagy_bootstrap_nav(@pagy, pagy_id: 'pagination').html_safe

      .table-responsive-xxl
        %table.table#reservations-table
          %thead
            %tr
              %th Name
              %th
              %th Street
              %th Route
              %th
          %tbody
            - @reservations.each do |reservation|
              %tr
                %td.name
                  %i.bi.bi-house-fill
                  &nbsp;
                  = link_to reservation.name, admin_reservation_path(reservation)
                  - if reservation.online_donation?
                    %i.bi.bi-stripe
                  - elsif reservation.cash_or_check_donation?
                    %i.bi.bi-cash
                  - elsif reservation.no_donation?
                %td.status= reservation_status(reservation)
                %td.map-links
                  - if reservation.coordinates.present?
                    = link_to reservation.street, "https://maps.apple.com/?q=#{reservation.latitude},#{reservation.longitude}", target: '_blank'
                    = link_to "https://www.google.com/maps/place/#{reservation.latitude},#{reservation.longitude}", target: '_blank' do
                      %i.bi.bi-google
                  - else
                    = reservation.street


                %td.route
                  - if reservation.route_id?
                    = link_to admin_reservations_path(route_id: reservation.route_id) do
                      = reservation&.route&.name
                      - if reservation.distance_to_route
                        = surround("(", ")") do
                          = pluralize(reservation.distance_to_route.round(2), "mile")
                  - if reservation.is_route_polygon?
                    %i.bi.bi-pentagon(data-bs-toggle="tooltip" data-bs-placement="top" title="Reservation is routed in a pentagon.")
                  - if reservation.routed_manually?
                    %i.bi.bi-pin-map(data-bs-toggle="tooltip" data-bs-placement="top" title="Reservation is routed manually.")
                %td.actions
                  = link_to edit_admin_reservation_path(reservation) do
                    %i.bi.bi-pencil-fill.icon
      
                  - unless reservation.cancelled?
                    = link_to admin_reservation_archive_path(reservation), method: :post, data: { 'turbo-method': :post, 'turbo-confirm': 'Are you sure? This will archive the reservation.' } do
                      %i.bi.bi-archive-fill.icon(data-bs-toggle="tooltip" data-bs-placement="top" title="Archive this reservation.")

                  = link_to [:admin, reservation], method: :delete, class: 'delete-reservation-button', data: { "turbo-method": :delete, 'turbo-confirm': 'Are you sure? This will permanently, and irreversibly destroy this reservation.' } do
                    %i.bi.bi-trash-fill.icon
                  = link_to admin_reservation_process_geocode_path(reservation), method: :post, id: "process-geocode-button-#{reservation.id}", data: { "turbo-method": :post } do
                    %i.bi.bi-geo-alt-fill.icon(data-bs-toggle="tooltip" data-bs-placement="top" title="Geocode reservation")
                  = link_to admin_reservation_process_route_path(reservation), method: :post, id: "process-route-button-#{reservation.id}", data: { "turbo-method": :post } do
                    %i.bi.bi-lightning-fill.icon(data-bs-toggle="tooltip" data-bs-placement="top" title="Route reservation")

      .pagination= pagy_bootstrap_nav(@pagy, pagy_id: 'pagination').html_safe
