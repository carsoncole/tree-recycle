<div class='container'>
<div class='text-center mb-2'>
<%- if @route %>
  <div id='map-title'>
    <%= @route.name_with_zone %>
  </div>
  <%= link_to "( < Back )", driver_route_path(@route) %>
<%- elsif @zone %>
  <div id='map-title'>
    <%= @zone.name  %>
  </div>
  <%= link_to "( <Back )", driver_root_path %>
<%- elsif @reservation %>
  <div id='map-title'>
    <%= @reservation.street  %>
  </div>
  <%= link_to "( <Back )", driver_reservation_path(@reservation) %>
<%- else %>
  <div id='map-title'>
    All
  </div>
  <%= link_to "( <Back )", driver_root_path %>

<%- end %>
</div>



<div id="map"></div>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= Rails.application.credentials.google_maps.api_key %>&callback=initMap&libraries=&v=weekly" async></script>
<script>

  // Initialize and add the map
  var map;
  function initMap() {

    let locations =  <%= raw @reservations %>;

    // Create the map, centered at gfg_office
    var map = new google.maps.Map(
            document.getElementById("map"), {

        // Set the zoom of the map
        <%- if @route %>
          zoom: 14,
          center: new google.maps.LatLng(<%= @route.latitude %>, <%= @route.longitude %>),
        <%- elsif @reservation %>
          zoom: 19,
          center: new google.maps.LatLng(<%= @reservation.latitude %>, <%= @reservation.longitude %>),
        <%- elsif @zone %>
          zoom: 14,
          center: new google.maps.LatLng(<%= @zone.latitude %>, <%= @zone.longitude %>),
        <%- else %>
          zoom: 12,
          center: new google.maps.LatLng(47.64483,-122.54827),
        <%- end %>
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });

    var infowindow = new google.maps.InfoWindow();

    for (i = 0; i < locations.length; i++) {

      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(locations[i][2], locations[i][3]),
        map: map,
        title: locations[i][1]
      });

      let html_content = `<div class='map-info-window'><a class='street' href='/driver/reservations/${locations[i][0]}'>${locations[i][1]}</a><br>` +
            `<div class='notes'>${locations[i][4]}</div>` +
            `<a type="button" data-turbo-method="patch" data-method="patch" data-turbo-confirm="Picked up? Are you sure?" class='btn btn-outline-success btn-sm' href='/driver/reservations/${locations[i][0]}?status=picked_up'>Picked Up</a> ` +
            `<a type="button" data-turbo-method="patch" data-method="patch" data-turbo-confirm="Missing? Are you sure? This will trigger an SMS message to the resident asking them to contact us." class='btn btn-outline-danger btn-sm' href='/driver/reservations/${locations[i][0]}?status=missing'>Missing</a></div>`

      google.maps.event.addListener(marker, 'click', (function (marker, i) {
        return function () {
          infowindow.setContent(html_content);
          infowindow.open(map, marker);
        }
      })(marker, i));
    }
  }

</script>
</div>
